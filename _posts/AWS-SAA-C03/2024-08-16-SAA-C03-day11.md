---
title: "SAA-C03 Day 12 | Message Broker"
date: 2024-08-14 00:00:00
categories: [AWS, SAA-C03]
tags: [SNS, SQS, Kinesis, MQ]
---

### Standard SQS
#### Attributes
  - unlimited throughput and umlimited message
  - default retention of message： 4 days, maximun 14 days
  - limit of 256KB
  - out of order message
  - can have duplicate messages
  - the message is persisted in sqs until a consumer deletes it

#### Security
  - IAM regulates the access to SQS API and 
  - SQS access Policies （whom can access to SQS, cross account）


### SQS - FIFO QUEUE
- Limit throughput 300 msg/s without batching, 3000 msg/s with
- Message are inorder if they have same group id

### SQS with ASG and cloudwatch
![Screenshot 2024-08-17 at 13 24 17](https://github.com/user-attachments/assets/eadba32b-16e9-49b8-a767-63cdf705a485)



### SQS Message Visibility Timeout
  - after a message is polled by a consumer , it becomes invisble to other consumers
  - Default time is 30 secs
  - if set tii high, and consumer crashes , reprocessing take time
  - if set too low, may get duplicates

### SQS Long Polling
  - when a consumer requests message from the queue it can wait for message to arrive （Long Polling）
  - decrease the number of API calls
  - wait time can be between（1 - 20）


### SNS 
  - send one message to many receiver
  - SNS can direct publish to （**SQS, Lambda, Kinesis DataFirehose Emails, SMS, Http(s) endpoint**)
  - but manymany services can send msg to SNS

#### SNS FIFO Topic
  - same as sqs fifo
  - can integrate with only sqs fifo queue

#### SNS Publish Message
  - Topic Publish : you publish messages to an SNS topic. All subscribers to that topic (such as SQS queues, Lambda functions, HTTP endpoints, or email addresses) will receive the message.
  - Direct Publish : In direct publishing, also known as SMS publishing, you can send messages directly to a phone number without involving a topic.

#### SNS Integration
  1. SNS + SQS FanOUT

     ![Screenshot 2024-08-17 at 13 34 00](https://github.com/user-attachments/assets/d8fcb5cd-d72c-4070-a21d-302e82884890)

  4. S3 Events to multiple queues
     ![Screenshot 2024-08-17 at 13 56 48](https://github.com/user-attachments/assets/6a66c43f-bfef-4350-81eb-b16f0cc7ecdd)

  6. SNS to Amazon S3 through Kinesis Data Firehose
     ![Screenshot 2024-08-17 at 13 57 30](https://github.com/user-attachments/assets/2cf900c5-8e84-4ff1-bf8f-65fe42aefa6b)

### SNS Message FIltering
  - JSON policy used to filter messages sent to SNS topic’s subscriptions
  - If a subscription doesn’t have a filter policy, it receives every message


### Kinesis
Make it easy to collect, process, and analyze streaming data in real-time
- Kinesis Data Streams: Kinesis Data Streams is primarily used to ingest and store large volumes of real-time data from various sources such as websites, mobile apps, IoT devices, and logs.
- Kinesis Data Firehose: load data streams into AWS data stores
- Kinesis Data Analytics: analyze data streams with SQL or Apache Flink


#### Kinesis Data Stream
- Producer send to data stream,  will have partition key (decide which shard the data goes)
- Retention between 1 day to 365 days
- can reprocess data
- Once Data is inserted in Kinesis, it cant be deleted 
- Consumer 
  1. write your own: KCL SDK
  2. managed AWS lambda, KDF, KDA

![Screenshot 2024-08-17 at 14 36 24](https://github.com/user-attachments/assets/1601536c-975f-4f43-a84a-12035a1fc2e6)

#### Kinesis Data Stream Capacity Modes
- Provisioned mode ( choose the number of shard, scale manually)
- On demand Mode : (No need to manage)


#### Kinesis Data Firehose
Firehose allows you to transform the data before delivering it to the destination. You can apply simple transformations, such as converting formats or compressing data, or you can use AWS Lambda to apply more complex transformations.
![Screenshot 2024-08-17 at 15 12 47](https://github.com/user-attachments/assets/c393b614-10df-450c-a758-d58c12759c93)

destination could be 
1. AWS: RedSHift / S3 /OpenSearch
2. 3rd Party partner: Splunk Mongo DB
3. Custom Http endpoint

- supports custom data transformations using AWS Lambda
- can send failed or all data to a backup S3 bucket

#### Kinesis Firehose vs Data stream
- Kinesis Data Streams: Think of it as a real-time messaging system where you want consumers to process data actively, similar to Kafka.
- Kinesis Data Firehose: Think of it as a managed service to move data from producers to destinations with optional transformation, but without the need for complex consumer logic. It’s more of a data transport and delivery mechanism.



#### Data Ordering for Kinesis and sqs FIFO
- FIFO within a Shard: Yes, records are FIFO within a shard. If two records are sent to the same shard, they will be consumed by the consumers in the same order they were added.
- Amazon SQS FIFO (First-In, First-Out) queues, if you have only one consumer, the messages will be processed in the exact order they were sent.
